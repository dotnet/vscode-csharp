parameters:
  - name: installDotNet
    type: string
  - name: testVSCodeVersion
    type: string

steps:
- checkout: self
  clean: true
  submodules: true
  fetchTags: false
  fetchDepth: 1

# The build.ubuntu.2204.amd64.open image is missing packages which are required for running integration tests.
- script: sudo apt-get update -y && sudo apt-get install -y libglib2.0-0 libnss3 libatk-bridge2.0-dev libdrm2 libgtk-3-0 libgbm-dev libasound2t64 xvfb
  displayName: 'Install additional Linux dependencies'
  target: host
  condition: eq(variables['Agent.OS'], 'Linux')

- template: prereqs.yml
  parameters:
    installDotNet: ${{ parameters.installDotNet }}

- template: test-prereqs.yml

- script: npm run omnisharptest
  displayName: ðŸ§ª Run unit and integration tests
  env:
    DISPLAY: :99.0
    CODE_VERSION: ${{ parameters.testVSCodeVersion }}

- task: PublishTestResults@2
  condition: succeededOrFailed()
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '*junit.xml'
    searchFolder: '$(Build.SourcesDirectory)/out'
    publishRunAttachments: true
    mergeTestResults: true
    testRunTitle: OmniSharp $(Agent.JobName) (Attempt $(System.JobAttempt))

- task: PublishPipelineArtifact@1
  condition: failed()
  displayName: 'Upload integration test logs'
  inputs:
    targetPath: '$(Build.SourcesDirectory)/.vscode-test/user-data/logs'
    artifactName: 'VSCode Test OmniSharp Logs ($(Agent.JobName)-$(System.JobAttempt))'
